@(username: String, twitterId: String)(implicit request: RequestHeader)

@import play.api.cache.Cache
@import play.api.Play.current
@import models.ChatRoom

    @getYouTubeId() = @{
        Cache.getOrElse[String]("youtubeid") {""}
    }

@main(Some(username)) {

    <div id="onError" class="alert-message error">
        <p>
            <strong>Oops!</strong> <span></span>
        </p>
    </div>


    <div class="row">
        <div class="span6">
            <iframe class="youtube-player" type="text/html"  width="100%" height="385"
                src="http://www.youtube.com/embed/@getYouTubeId()" frameborder="0">
            </iframe>
        </div>
        <div id="onChat" class="span5">
            <div id="main" style="height:390px;">
                <div id="messages">
                </div>
                <textarea id="talk"></textarea>
            </div>
        </div>
        <div class="span2" style="border-bottom: 2px solid #eee;">
            <h3 id="members-title" style="margin-top:0px;">Membres</h3>
            <ul id="members">
            </ul>
        </div>
    </div>

    <script type="text/javascript" charset="utf-8">

        $(function() {

			var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
            var chatSocket = new WS("@routes.Application.chat(username, twitterId).webSocketURL()")

            var sendMessage = function() {
                chatSocket.send(JSON.stringify(
                    {text: $("#talk").val()}
                ))
                $("#talk").val('')
            }

            var urlExt = new RegExp("(((file|gopher|news|nntp|telnet|http|ftp|https|ftps|sftp)://)|(www\.))+(([a-zA-Z0-9\._-]+\.[a-zA-Z]{2,6})|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(/[a-zA-Z0-9\&amp;%_\./-~-]*)?", "g")

            var receiveEvent = function(event) {
                var data = JSON.parse(event.data)

                // Handle errors
                if(data.error) {
                    chatSocket.close()
                    $("#onError span").text(data.error)
                    $("#onError").show()
                    return
                } else {
                    $("#onChat").show()
                }

                // Create the message element
                var el = $('<div class="message"><span></span><img src="' + data.avatar + '" class="pull-right" style="margin-right: 10px;"></img><br/></div>')
                $("span", el).text(data.user)
                $(el).append("<p>"+data.message.replace(urlExt, "<a href=\"$&\" target=_blank>$&</a>")+"</p>")

                $(el).addClass(data.kind)
                if(data.user == '@username') $(el).addClass('me')
                $('#messages').append(el)

                //Scroll to the bottom
                var height = $('#messages')[0].scrollHeight;
                $('#messages').scrollTop(height);

                // Update the members list
                $("#members").html('')
                $(data.members).each(function() {
                $("#members").append('<li>' + this + '</li>')
                })

                //Update the members number
                $("#members-title").html(data.members.length + ' Membres')

            }

            var handleReturnKey = function(e) {
                if(e.charCode == 13 || e.keyCode == 13) {
                    e.preventDefault()
                    sendMessage()
                }
            }

            $("#talk").keypress(handleReturnKey)

            chatSocket.onmessage = receiveEvent

        })

    </script>

}
