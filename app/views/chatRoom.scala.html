@(username: String, twitterId: String)(implicit request: RequestHeader)

@import play.api.cache.Cache
@import play.api.Play.current
@import models.ChatRoom

    @getYouTubeId() = @{
        Cache.getOrElse[String]("youtubeid") {""}
    }

@main(Some(username)) {

    <div id="onError" class="alert-message error">
        <p>
            <strong>Oops!</strong> <span></span>
        </p>
    </div>

    <div class="row">
        <div class="span6">
            <div id="ytplayer"></div>
            <button class="btn btn-primary" id="reloadvideo" onclick="reloadVideo()">Synchronisation avec le direct</button>
        </div>
        <div id="onChat" class="span5" style="margin-left: 10px;">
            <div id="main" style="height:390px;">
                <div id="messages">
                </div>
                <textarea id="talk" style="width: 360px;"></textarea>
            </div>
            @if(username.contains("@")) {
                <a href="#" id="help" onclick="toggleHelp()" class="badge badge-info" rel="popover" trigger="hover" data-content="Tapez save:'text' pour sauvegarder un texte en vous envoyant un direct message" data-original-title="Aide">
                    Aide</a>
            }
        </div>
        <div class="span2" style="border-bottom: 2px solid #aaa; margin-left: 10px;">
            <h4 id="members-title" style="margin-top:0px;">Membres</h4>
            <ul id="members">
            </ul>
        </div>
    </div>

    <br/><br/>
    <br/>
    <footer>
            <a rel="license" target="_blank" href="http://creativecommons.org/licenses/by/3.0/deed.fr"><img alt="Licence Creative Commons" style="border-width:0;text-align:center;" src="http://i.creativecommons.org/l/by/3.0/88x31.png" /></a>
    </footer>

    <script type="text/javascript" charset="utf-8">

        var tag = document.createElement('script');
        tag.src = "//www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('ytplayer', {
                    height: '385',
                    width: '100%',
                    playerVars: { 'autoplay': 1, 'autohide': 1 },
                    videoId: '@getYouTubeId()',
                    events: {
                        'onReady': onPlayerReady
                        }
                    });
        }

        function onPlayerReady(event) {
            // event.target.playVideo();
        }


        function reloadVideo() {
          player.loadVideoById("@getYouTubeId()")
        }

        function toggleHelp() {
            $("#help").popover('toggle')
        }

        $(function() {

			var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
            var chatSocket = new WS("@routes.Application.chat(username, twitterId).webSocketURL()")

            var sendMessage = function() {
                chatSocket.send(JSON.stringify(
                    {text: $("#talk").val()}
                ))
                $("#talk").val('')
            }

            var urlExt = new RegExp("(((file|gopher|news|nntp|telnet|http|ftp|https|ftps|sftp)://)|(www\.))+(([a-zA-Z0-9\._-]+\.[a-zA-Z]{2,6})|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(/[a-zA-Z0-9\&amp;%_\./-~-]*)?", "g")

            var receiveEvent = function(event) {
                var data = JSON.parse(event.data)

                // Handle errors
                if(data.error) {
                    chatSocket.close()
                    $("#onError span").text(data.error)
                    $("#onError").show()
                    return
                } else {
                    $("#onChat").show()
                }

                // Create the message element
                var el = $('<div class="message"><span></span><em style="font-size:10px; color:#aaa"></em><img src="' + data.avatar + '" class="pull-right" style="margin-right: 10px;"></img><br/></div>')
                $("span", el).text(data.user)
                var now = new Date()
                var min = now.getMinutes() + ""
                if (min.length == 1) {
                    min = "0" + min
                }
                $("em", el).text(now.getHours() + ':' + min)
                $(el).append("<p>"+data.message.replace(urlExt, "<a href=\"$&\" target=_blank>$&</a>")+"</p>")

                $(el).addClass(data.kind)
                if(data.user == '@username') $(el).addClass('me')
                $('#messages').append(el)

                //Scroll to the bottom
                var height = $('#messages')[0].scrollHeight;
                $('#messages').scrollTop(height);

                // Update the members list
                $("#members").html('')
                $(data.members).each(function() {
                $("#members").append('<li>' + this + '</li>')
                })

                //Update the members number
                $("#members-title").html(data.members.length + ' Membres')

            }

            var handleReturnKey = function(e) {
                if(e.charCode == 13 || e.keyCode == 13) {
                    e.preventDefault()
                    sendMessage()
                }
            }

            $("#talk").keypress(handleReturnKey)

            chatSocket.onmessage = receiveEvent

        })

    </script>

}
